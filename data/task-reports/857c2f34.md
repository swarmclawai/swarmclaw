# Task 857c2f34: [Bug] WhatsApp images not working

- Status: completed
- Agent: fcd98bac
- Session: 81a76a3a

## Description
Images sent via WhatsApp are not being processed correctly. User reports the feature is broken.

Investigation needed:
1. Check connector message handling for media attachments
2. Verify image download/processing flow
3. Check if media URLs are being resolved correctly
4. Test with actual WhatsApp image messages

Related: check connector_flow memory and src/lib/server/connectors for media handling code.

## Result Summary
All confirmed. Here's the summary:

## Root Cause

The WhatsApp image download/save pipeline was working correctly — images were being downloaded via Baileys, saved to disk with `saveInboundMediaBuffer()`, and an `InboundMedia` object with both `url` and `localPath` was being created. **But the `localPath` was never passed forward to the LLM.**

In `manager.ts:routeMessage()`:
1. The session message only stored `imageUrl` (the public `/api/uploads/...` URL), not `imagePath` (the local disk path)
2. The `streamAgentChat()` call (tools path) didn't include `imagePath`
3. The `provider.streamChat()` call (non-tools path) didn't include `imagePath` either

Since `stream-agent-chat.ts:buildLangChainContent()` reads images from disk via `imagePath` and all providers also use `imagePath` to encode images into their API calls, the image was invisible to the LLM in every code path.

## Fix (3 changes in `manager.ts`)

1. **Line 171-181**: Extract `localPath` from the first image media and store it as `imagePath` on the session message (so history replay also works)
2. **Line 194-202**: Pass `imagePath: firstImagePath` to `streamAgentChat()`
3. **Line 214-219**: Pass `imagePath: firstImagePath` to `provider.handler.streamChat()`

## Changed Files
- In `manager.ts:routeMessage()`:
- Since `stream-agent-chat.ts:buildLangChainContent()` reads images from disk via `imagePath` and all providers also use `imagePath` to encode images into their API calls, the image was invisible to the LLM in every code path.
- ## Fix (3 changes in `manager.ts`)

## Commands Run
- Not provided

## Verification
- The WhatsApp image download/save pipeline was working correctly — images were being downloaded via Baileys, saved to disk with `saveInboundMediaBuffer()`, and an `InboundMedia` object with both `url` and `localPath` was being created. **But the `localPath` was never passed forward to the LLM.**
