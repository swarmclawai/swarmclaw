# Task 09ee66ae: Fix heartbeat staleness issues

- Status: completed
- Agent: fcd98bac
- Session: bc8f61c0

## Description
Investigate and fix heartbeat staleness. Session 'webhook:qa_webhook' shows last active 4746s ago (79 minutes) but heartbeat interval is 120s.

Issues to investigate:
1. Why heartbeat signals aren't being sent/received properly
2. Check orchestrator heartbeat logic
3. Check daemon health check implementation
4. Test heartbeat with actual long-running sessions
5. Ensure sessions table last_active_at is updated correctly

The heartbeat system should ping every ~120s for active sessions.

## Result Summary
## Summary

**Root cause:** In `src/lib/server/chat-execution.ts:521-525`, `lastActiveAt` was only updated when `changed` was `true` — which required either a message to be persisted or delegate resume IDs to change.

For heartbeat runs:
- `internal=true` → user message not added (line 311 skipped)
- LLM responds `'HEARTBEAT_OK'` → `shouldPersistAssistant = false` (line 473: `!internal || finalText !== 'HEARTBEAT_OK'`)
- No resume ID changes for heartbeat runs
- `changed` stays `false` → **`lastActiveAt` never updated**

The heartbeat service was correctly enqueuing runs, the LLM was correctly responding, but the timestamp proving the session was alive was gated behind message persistence logic.

**Fix:** Moved `current.lastActiveAt = Date.now()` outside the `if (changed)` conditional so it always executes after a successful run, then unconditionally saves the session. A heartbeat run proves liveness even when its response isn't stored as a message.

## Changed Files
- **Root cause:** In `src/lib/server/chat-execution.ts:521-525`, `lastActiveAt` was only updated when `changed` was `true` — which required either a message to be persisted or delegate resume IDs to change.

## Commands Run
- Not provided

## Verification
- Not provided
