# Task ec5126b3: Research OpenClaw browser/screenshot implementation

- Status: completed
- Agent: fcd98bac
- Session: 50b7b7f2

## Description
Look at OpenClaw codebase (github.com/OpenClaw/openclaw or similar) to understand how they handle browser automation and screenshot delivery. We're having issues where screenshots aren't being delivered to WhatsApp users. Check their browser tool implementation, how they capture and return screenshots, and how they integrate with messaging platforms. Report findings back so we can fix our screenshot delivery.

## Result Summary
Now I have the complete picture. Here's the full analysis:

---

## Findings: Screenshot Delivery to WhatsApp is Broken

**OpenClaw** is your own local LLM server (`localhost:18789`), not an external project — there's no public repo or browser automation code to reference there.

But the investigation revealed the exact bug in the screenshot delivery pipeline:

### The Problem

There's a **disconnect between how screenshots are returned and how WhatsApp sends them**:

1. **Browser tool** (`session-tools.ts:1497-1504`) captures a screenshot, saves the PNG to `data/uploads/`, and returns a **markdown string** to the LLM:
   ```
   ![Screenshot](/api/uploads/screenshot-1234567.png)
   ```

2. **`routeMessage()`** (`manager.ts`) calls `streamAgentChat()` which returns `fullText` — the agent's final text response containing that markdown string.

3. **WhatsApp handler** (`whatsapp.ts:312-313`) receives this text and calls:
   ```ts
   await instance.sendMessage(jid, response)  // just plain text, no options
   ```

4. **`sendMessage()`** (`whatsapp.ts:64-96`) *does* support sending images — but only when `options.imageUrl` is provided:
   ```ts
   if (options?.imageUrl) {
     await sock.sendMessage(channelId, { image: { url: options.imageUrl }, caption: ... })
   }
   ```

### Result

The WhatsApp user receives a raw text string like `![Screenshot](/api/uploads/screenshot-1234567.png)` — a relative URL that means nothing to them, instead of an actual image attachment.

### The Fix Needed

In `whatsapp.ts` around line 309-313, before sending the response, the code needs to:

1. **Detect image markdown** in the response text (e.g. `![...](/api/uploads/...)`)
2. **Resolve the local file path** from the URL to `data/uploads/screenshot-xxx.png`
3. **Call `sendMessage()` with `imageUrl`** pointing to the local file path (Baileys supports `{ image: { url: '/absolute/path/to/file.png' } }`)
4. **Strip the markdown** from the text and send any remaining text separately

The same

## Changed Files
- 1. **Browser tool** (`session-tools.ts:1497-1504`) captures a screenshot, saves the PNG to `data/uploads/`, and returns a **markdown string** to the LLM:
- 2. **`routeMessage()`** (`manager.ts`) calls `streamAgentChat()` which returns `fullText` — the agent's final text response containing that markdown string.
- 3. **WhatsApp handler** (`whatsapp.ts:312-313`) receives this text and calls:
- 4. **`sendMessage()`** (`whatsapp.ts:64-96`) *does* support sending images — but only when `options.imageUrl` is provided:
- In `whatsapp.ts` around line 309-313, before sending the response, the code needs to:

## Commands Run
- Not provided

## Verification
- Not provided
