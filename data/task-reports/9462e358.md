# Task 9462e358: Fix stale session heartbeat detection and cleanup

- Status: completed
- Agent: fcd98bac
- Session: 79826967

## Description
Audit heartbeat mechanism. Session cleanup on daemon startup. Stale detection thresholds. Health alert improvements (alert once per stale session). Auto-disable heartbeat when task completes.

## Result Summary
Zero type errors. The build failure is a pre-existing Next.js prerender issue (`useContext` null in `/_global-error`), unrelated to these changes.

---

**Summary of changes:**

### `heartbeat-service.ts`
1. **Startup seed** — New `seedLastActive()` called on `startHeartbeatService()`. Populates `lastBySession` from persisted `session.lastActiveAt` values so a cold restart doesn't cause every session to fire heartbeats simultaneously on the first tick.
2. **Session pruning** — Each `tickHeartbeats()` now iterates `lastBySession` and removes entries for sessions that no longer exist or have heartbeat disabled. This auto-cleans up when an agent calls `set_heartbeat` to disable, or when a session is deleted.

### `daemon-state.ts`
3. **Alert-once semantics** — Replaced `issueLastAlertAt: Map<string, number>` (10-min cooldown per issue) with `staleSessionIds: Set<string>`. Health alerts now fire exactly once per stale episode — on the healthy→stale transition — instead of repeating every 10 minutes.
4. **Recovery tracking** — After each health check, sessions that are no longer stale get removed from `staleSessionIds`, allowing them to re-alert if they go stale again later.
5. **Named threshold constants** — Extracted `STALE_MULTIPLIER = 4` and `STALE_MIN_MS = 4min` from the opaque `intervalSec * 4000` formula.
6. **HMR migration** — Backfill logic cleans up the old `issueLastAlertAt` field if present on `globalThis` from a previous code version.

## Changed Files
- Zero type errors. The build failure is a pre-existing Next.js prerender issue (`useContext` null in `/_global-error`), unrelated to these changes.
- ### `heartbeat-service.ts`
- ### `daemon-state.ts`

## Commands Run
- Not provided

## Verification
- Zero type errors. The build failure is a pre-existing Next.js prerender issue (`useContext` null in `/_global-error`), unrelated to these changes.
