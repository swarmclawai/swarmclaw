# Task 6b0f7432: Auto-disable heartbeat when task completes

- Status: completed
- Agent: fcd98bac
- Session: ab67df97

## Description
When task is marked completed/failed, automatically call sessions_tool set_heartbeat(heartbeatEnabled=false) on the running session. Also add cleanup on daemon startup for sessions whose tasks are done.

## Result Summary
Done. Here's what was changed:

**`src/lib/server/queue.ts`**:
- Added `disableSessionHeartbeat()` helper — loads the session by ID, sets `heartbeatEnabled = false` and updates `lastActiveAt`, then saves. No-ops if session doesn't exist or heartbeat is already off.
- Called after task completion (line 113) and after task failure (line 137).
- Added exported `cleanupFinishedTaskSessions()` — scans all tasks with `completed`/`failed` status that have a `sessionId`, and batch-disables heartbeat on any of those sessions that still have it enabled.

**`src/lib/server/daemon-state.ts`**:
- Imported `cleanupFinishedTaskSessions` from `./queue`.
- Called it at the top of `startDaemon()` (before starting the scheduler/queue processor) so stale heartbeats from a previous run are cleaned up on boot.

## Changed Files
- **`src/lib/server/queue.ts`**:
- **`src/lib/server/daemon-state.ts`**:

## Commands Run
- Not provided

## Verification
- Added exported `cleanupFinishedTaskSessions()` — scans all tasks with `completed`/`failed` status that have a `sessionId`, and batch-disables heartbeat on any of those sessions that still have it enabled.
